<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/plantilla :: head}">
    <!-- Hoja de estilos -->
    <link th:href="@{/css/styles.css}" rel="stylesheet"/>
</head>
<body>
<header th:replace="~{layout/plantilla :: header}"></header>
<main class="container-xl presu-container">
    <div class="row g-0 align-items-stretch">

        <!-- Izquierda: panel importante -->
        <aside class="col-12 col-lg-3 p-3 p-md-4 panel-izq">
            <div class="text-center mb-3">
                <span class="badge-importante">[[#{importante}]]</span>
            </div>

            <div class="card panel-izq-card p-3">
                <small class="text-light">
                    [[#{mensaje.presupuesto.1}]] <br><br>
                    [[#{mensaje.presupuesto.2}]] <br><br>
                    [[#{mensaje.presupuesto.3}]] <br><br>
                    [[#{mensaje.presupuesto.4}]]
                </small>
            </div>
        </aside>

        <!-- Franja vertical con background desde CSS -->
        <div class="d-none d-lg-block franja col-lg-1"></div>

        <!-- Derecha: formulario -->
        <section class="col-12 col-lg-8 p-3 p-md-4 panel-der">
            <header class="mb-4 text-center text-lg-start">
                <h1 class="display-6 fw-bold titulo">[[#{envianos.proyecto}]]</h1>
                <p class="lead subtitulo">[[#{mensaje.presupuesto.5}]]</p>
            </header>

            <div class="card card-form p-4">
                <form class="row g-4" th:action="@{/servicios/enviar}" method="post" id="form">

                    <!-- Fila 1: Área / Acabados -->
                    <div class="col-12 col-md-6">
                        <label for="area" class="form-label">[[#{area.construccion}]]</label>
                        <input id="area" name="area" type="number" step="0.01" class="form-select2" required></select>
                    </div>

                    <div class="col-12 col-md-6">
                        <label for="acabados" class="form-label">[[#{tipos.acabados}]]</label>
                        <select id="acabados" name="acabados" class="form-select2" required>
                            <option th:each="acabado : ${acabados}" th:value="${acabado.nombre}"
                                    th:text="${acabado.nombre}"></option>
                        </select>
                    </div>

                    <!-- Fila 2: Terreno / Ubicación (mapa) -->
                    <div class="col-12 col-md-6">
                        <label for="terreno" class="form-label">[[#{tipo.terreno}]]</label>
                        <select id="terreno" name="terreno" class="form-select2" required>
                            <option th:each="terreno : ${terrenos}" th:value="${terreno.nombre}"
                                    th:text="${terreno.nombre}"></option>
                        </select>

                        <div class="alert texto-nota mt-4 mb-0 text-center">
                            [[#{mensaje.presupuesto.6}]]
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">[[#{ubicacion}]]</label>
                        <div id="map" class="mini-mapa"></div>
                        <br>
                        <input type="hidden" name="ubicacion" id="ubicacionHidden" required>
                        <input type="text" class="form-select2" placeholder="Ubicación" id="mapLink" readonly>
                    </div>

                    <!-- Botón -->
                    <div class="col-12 d-flex justify-content-center justify-content-md-start">
                        <button type="submit" class="btn btn-enviar px-4">[[#{accion.enviar}]]</button>
                    </div>
                </form>
            </div>
        </section>
    </div>
</main>
<script>
    document.addEventListener("DOMContentLoaded", function(){
      var map = L.map('map').setView([9.934739, -84.090724], 13); // Coordenadas iniciales: San José CR

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
      }).addTo(map);

      var marker;

    map.on('click', function(e) {
      var lat = e.latlng.lat;
      var lng = e.latlng.lng;

      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }

      var link = "https://www.google.com/maps?q=" + lat + "," + lng;
      document.getElementById("mapLink").value = link;
      document.getElementById("ubicacionHidden").value = link;
    });
    
    var form = document.getElementById("form");
    form.addEventListener("submit", function(e) {
        var ubicacion = document.getElementById("ubicacionHidden").value;
        if (!ubicacion) {
          e.preventDefault(); 
          alert("Por favor selecciona una ubicación en el mapa antes de enviar.");
        }
  });
    });
</script>
</body>
</html>